#!/bin/ksh
set -x

if [ $# -lt 1 ]
then
    echo "usage $0 fname"
    exit
fi

nawk 'BEGIN{FS="~"}
     {	   
	   if (NR==FNR) 
	   {
		key=$1","$2","$3","$4","$5","$6","$7;
		lobcaptyp[key]=$8","$9;
		next;
	   }
	   else
	   {
		if (FNR==1)
		{
			print "LOB,CAPTYP,"$1","$2","$3" "$4","$5","$6","$7","$8","$9","$10","$11","$12","$13","$14","$15","$16","$17","$18","$21","$24","$25","$26","$27","$32","$35","$40","$41","$42","$43","$44","$45","$46","$47","$48","$53","$55","$56","$58","$66","$67","$68","$70","$72","$73;
		}
		str=$6","$8","$10","$15","$55","$46","$40;
		gsub(/ /,"",str);
		if (lobcaptyp[str])
		{
			print lobcaptyp[str]","$1","$2","$3" "$4","$5","$6","$7","$8","$9","$10","$11","$12","$13","$14","$15","$16","$17","$18","$21","$24","$25","$26","$27","$32","$35","$40","$41","$42","$43","$44","$45","$46","$47","$48","$53","$55","$56","$58","$66","$67","$68","$70","$72","$73;
		}
	   }
     }' CapType_SourceMapping.csv LD_HDR_DTL>LD_HDR_DTL.out

nawk 'BEGIN{FS=","}
     {
           if (NR==FNR)
           {
                loadid[$3]=$3;
                next;
           }
           else
           {
		FS="~"
                if (loadid[$2])
                {
			print $1"~"$2"~"$3"~"$4"~"$5"~"$6"~"$7"~"$8" "$9"~"$10"~"$11"~"$12"~"$13"~"$18"~"$19"~"$20"~"$21"~"$22" "$23"~"$24"~"$25" "$26"~"$27"~"$28"~"$29"~"$30"~"$31"~"$32"~"$33"~"$34"~"$35"~"$36;
                }
           }
     }' LD_HDR_DTL.out LD_STP_DTL>LD_STP_DTL.out
